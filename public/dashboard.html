<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="shortcut icon" href="https://6afuiqe8xb.ucarecd.net/278cf1a5-2273-4c27-89a9-b2f60b90e75d/shibainuwrittingonpapernoteillustrationsvgdownloadpng9803777.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neo-yellow': '#FFEB3B', 'neo-pink': '#FF6B9D',
                        'neo-blue': '#4FC3F7', 'neo-green': '#66FF99',
                        'neo-purple': '#C77DFF', 'neo-orange': '#FF9800',
                    },
                    fontFamily: {
                        'pixel': ['"Press Start 2P"', 'cursive'],
                        'sans': ['"Noto Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Sans', sans-serif; 
            background-color: #FFEB3B;
            font-size: 14px;
            line-height: 1.5;
        }
        .text-pixel { font-family: 'Press Start 2P', cursive; }
        .pixel-border { border: 4px solid #000; box-shadow: 8px 8px 0px #000; }
        .pixel-border-sm { border: 3px solid #000; box-shadow: 4px 4px 0px #000; }
        .pixel-input { 
            border: 4px solid #000; 
            background-color: white; 
            font-family: 'Noto Sans', sans-serif;
            font-size: 14px;
        }
        .pixel-input:focus { outline: none; transform: translate(2px, 2px); }
        .pixel-btn { 
            border: 4px solid #000; 
            box-shadow: 6px 6px 0px #000; 
            transition: all 0.1s;
            font-family: 'Press Start 2P', cursive;
        }
        .pixel-btn:hover { transform: translate(2px, 2px); box-shadow: 4px 4px 0px #000; }
        .pixel-btn:active { transform: translate(6px, 6px); box-shadow: 0px 0px 0px #000; }
        .ql-toolbar, .ql-container { border: 4px solid #000 !important; }
        .ql-toolbar { 
            border-bottom: 0 !important;
            background: #f8f9fa;
        }
        .ql-editor { 
            min-height: 150px; 
            background-color: #fff;
            font-size: 14px;
            font-family: 'Noto Sans', sans-serif;
        }
        .ql-snow .ql-picker { font-size: 13px; }
    </style>
</head>
<body class="bg-neo-yellow text-black">

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="text-white text-xs text-pixel mt-4">Memproses...</p>
        </div>
    </div>

    <nav class="bg-neo-pink p-3 pixel-border mb-6">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <h1 class="text-sm text-pixel">Dashboard Admin</h1>
                <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1.5 text-[10px] text-pixel pixel-btn">Logout</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-4 px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-neo-blue p-4 pixel-border">
                <h2 id="formTitle" class="text-xs text-pixel bg-white px-3 py-1.5 pixel-border-sm inline-block mb-4">Tambah Soal Kuis</h2>
                 <button onclick="window.location.href='/monitor'" class="bg-neo-purple text-black px-3 py-1.5 text-[10px] text-pixel pixel-btn flex items-center gap-2 mb-4">
                        Monitoring Siswa
                </button>
                <form id="addQuizForm" class="space-y-3">
                    <input type="hidden" id="editQuizId">
                    <input type="hidden" id="imageBase64" name="imageBase64">
                    <input type="hidden" id="imageMimeType" name="imageMimeType">
                    <div>
                        <label class="block text-[10px] text-pixel bg-white px-2 py-1 pixel-border-sm inline-block mb-2">Pertanyaan</label>
                        <div id="editor"></div>
                    </div>
                    <div>
                        <label class="block text-[10px] text-pixel bg-white px-2 py-1 pixel-border-sm inline-block mb-2">Gambar (Opsional)</label>
                        <input type="file" id="image_file" name="image_file" accept="image/png, image/jpeg" class="w-full text-xs p-2 pixel-input file:mr-3 file:py-1 file:px-2 file:border-0 file:text-[10px] file:text-pixel file:bg-neo-yellow file:text-black hover:file:bg-neo-pink"/>
                        <div class="mt-2">
                            <img id="image_preview" class="hidden w-24 h-24 object-cover pixel-border-sm" src="" alt="Preview">
                            <button type="button" id="removeImageBtn" class="hidden mt-2 text-[10px] bg-red-500 text-white px-2 py-1 text-pixel pixel-btn">Hapus</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <input type="text" id="option_a" placeholder="Pilihan A" required class="w-full px-2 py-1.5 pixel-input text-sm">
                        <input type="text" id="option_b" placeholder="Pilihan B" required class="w-full px-2 py-1.5 pixel-input text-sm">
                        <input type="text" id="option_c" placeholder="Pilihan C" required class="w-full px-2 py-1.5 pixel-input text-sm">
                        <input type="text" id="option_d" placeholder="Pilihan D" required class="w-full px-2 py-1.5 pixel-input text-sm">
                        <input type="text" id="option_e" placeholder="Pilihan E" required class="w-full px-2 py-1.5 pixel-input text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] text-pixel bg-white px-2 py-1 pixel-border-sm inline-block mb-2">Jawaban Benar</label>
                        <select id="correct_answer" required class="w-full px-2 py-1.5 pixel-input appearance-none text-sm"></select>
                    </div>
                    <div class="flex gap-2 pt-3">
                        <button id="submitBtn" type="submit" class="flex-1 bg-neo-green text-black py-1.5 text-pixel text-[10px] pixel-btn">Simpan Soal</button>
                        <button id="cancelBtn" type="button" class="hidden flex-1 bg-gray-500 text-white py-1.5 text-pixel text-[10px] pixel-btn">Batal</button>
                    </div>
                </form>
            </div>

            <div class="bg-neo-purple p-4 pixel-border">
                <h2 class="text-xs text-pixel bg-white px-3 py-1.5 pixel-border-sm inline-block mb-4">Daftar Soal</h2>
                <div id="quizList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
            </div>

        </div>

        <div class="bg-neo-green p-4 pixel-border mt-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 gap-3">
                 <h2 class="text-xs text-pixel bg-white px-3 py-1.5 pixel-border-sm inline-block">Hasil Jawaban Siswa</h2>
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-pixel">Filter Kelas:</label>
                        <select id="classFilter" class="px-2 py-1 pixel-input appearance-none text-xs"></select>
                    </div>
                    <button id="downloadBtn" class="bg-neo-blue text-black px-3 py-1.5 text-[10px] text-pixel pixel-btn flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Download
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto pixel-border bg-white">
                <table class="min-w-full divide-y-4 divide-black">
                    <thead class="bg-neo-yellow">
                        <tr>
                            <th class="px-4 py-2 text-left text-[10px] text-pixel uppercase">Nama</th>
                            <th class="px-4 py-2 text-left text-[10px] text-pixel uppercase">Absen</th>
                            <th class="px-4 py-2 text-left text-[10px] text-pixel uppercase">Kelas</th>
                            <th class="px-4 py-2 text-left text-[10px] text-pixel uppercase">Nilai</th>
                            <th class="px-4 py-2 text-left text-[10px] text-pixel uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable" class="bg-white divide-y-4 divide-black"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const quizForm = document.getElementById('addQuizForm');
        const quizList = document.getElementById('quizList');
        const submissionsTable = document.getElementById('submissionsTable');
        const logoutBtn = document.getElementById('logoutBtn');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const editQuizIdInput = document.getElementById('editQuizId');
        const classFilter = document.getElementById('classFilter');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const imageFileInput = document.getElementById('image_file');
        const imagePreview = document.getElementById('image_preview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const imageBase64Input = document.getElementById('imageBase64');
        const imageMimeTypeInput = document.getElementById('imageMimeType');
        
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }, { 'font': [] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }, { 'align': [] }],
            ['blockquote', 'code-block', 'link'],
            ['clean']
        ];

        const quill = new Quill('#editor', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow'
        });

        let allQuizzes = [];

        function populateSelectWithOptions() {
            const classSelect = document.getElementById('classFilter');
            const answerSelect = document.getElementById('correct_answer');
            const classes = ["semua", "XII.H", "XII.I", "XII.J"];
            const answers = [{value: 'a', text: 'A'}, {value: 'b', text: 'B'}, {value: 'c', text: 'C'}, {value: 'd', text: 'D'}, {value: 'e', text: 'E'}];
            
            classSelect.innerHTML = classes.map(c => `<option value="${c}">${c === 'semua' ? 'Semua Kelas' : c}</option>`).join('');
            answerSelect.innerHTML = answers.map(a => `<option value="${a.value}">${a.text}</option>`).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateSelectWithOptions();
            loadQuizzes();
            loadSubmissions();
        });
        
        classFilter.addEventListener('change', () => loadSubmissions(classFilter.value));
        downloadBtn.addEventListener('click', downloadExcel);
        cancelBtn.addEventListener('click', cancelEdit);

        imageFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                Swal.fire('Ukuran File Terlalu Besar', 'Ukuran gambar tidak boleh lebih dari 2MB.', 'error');
                imageFileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                imagePreview.src = dataUrl;
                imagePreview.classList.remove('hidden');
                removeImageBtn.classList.remove('hidden');
                const [header, base64Data] = dataUrl.split(',');
                const mimeType = header.match(/:(.*?);/)[1];
                imageBase64Input.value = base64Data;
                imageMimeTypeInput.value = mimeType;
            };
            reader.readAsDataURL(file);
        });

        removeImageBtn.addEventListener('click', () => {
            imageFileInput.value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            removeImageBtn.classList.add('hidden');
            imageBase64Input.value = '';
            imageMimeTypeInput.value = '';
        });

        async function downloadExcel() {
            const selectedClass = classFilter.value;
            const className = selectedClass === 'semua' ? 'Semua_Kelas' : selectedClass;
            const response = await fetch(`/api/submissions?kelas=${encodeURIComponent(selectedClass)}`);
            const submissions = await response.json();

            if (submissions.length === 0) {
                Swal.fire('Tidak Ada Data', `Tidak ada data nilai untuk kelas ${className} yang bisa diunduh.`, 'warning');
                return;
            }

            const dataForExcel = submissions.map(s => ({
                "Tanggal Pengerjaan": new Date(s.submitted_at).toLocaleDateString('id-ID'),
                "Nama Siswa": s.student_name, "No. Absen": s.student_absen,
                "Kelas": s.student_class, "Nilai": s.score,
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Nilai Siswa");
            worksheet["!cols"] = Object.keys(dataForExcel[0]).map(key => ({ wch: Math.max(key.length, ...dataForExcel.map(row => String(row[key] || "").length)) + 2 }));
            XLSX.writeFile(workbook, `Nilai_Quiz_${className.replace(/\./g, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function handleEdit(quizId) {
            const quizToEdit = allQuizzes.find(q => q.id === quizId);
            if (!quizToEdit) return;

            formTitle.textContent = 'Edit Soal Kuis';
            submitBtn.textContent = 'Update Soal';
            cancelBtn.classList.remove('hidden');
            
            editQuizIdInput.value = quizToEdit.id;
            quill.root.innerHTML = quizToEdit.question;

            if (quizToEdit.image_base64 && quizToEdit.image_mimetype) {
                imagePreview.src = `data:${quizToEdit.image_mimetype};base64,${quizToEdit.image_base64}`;
                imagePreview.classList.remove('hidden');
                removeImageBtn.classList.remove('hidden');
                imageBase64Input.value = quizToEdit.image_base64;
                imageMimeTypeInput.value = quizToEdit.image_mimetype;
            } else {
                removeImageBtn.click();
            }
            
            quizForm.option_a.value = quizToEdit.options.a;
            quizForm.option_b.value = quizToEdit.options.b;
            quizForm.option_c.value = quizToEdit.options.c;
            quizForm.option_d.value = quizToEdit.options.d;
            quizForm.option_e.value = quizToEdit.options.e;
            quizForm.correct_answer.value = quizToEdit.correct_answer;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            formTitle.textContent = 'Tambah Soal Kuis';
            submitBtn.textContent = 'Simpan Soal';
            cancelBtn.classList.add('hidden');
            editQuizIdInput.value = '';
            quizForm.reset();
            quill.setText('');
            removeImageBtn.click();
        }

        async function loadQuizzes() {
            const response = await fetch('/api/quizzes');
            allQuizzes = await response.json();
            quizList.innerHTML = allQuizzes.map((q, i) => `
                <div class="bg-white p-3 pixel-border-sm flex justify-between items-start gap-3">
                    <div class="flex-grow">
                        ${q.image_base64 ? `<img src="data:${q.image_mimetype};base64,${q.image_base64}" alt="Gambar Soal" class="w-20 h-20 object-cover pixel-border-sm mb-2">` : ''}
                        <div class="font-bold text-xs mb-1">${i + 1}.</div>
                        <div class="prose prose-sm text-sm leading-relaxed">${q.question}</div>
                        <small class="text-green-600 font-semibold mt-1 block text-xs">Jawaban: ${q.correct_answer.toUpperCase()}</small>
                    </div>
                    <div class="flex flex-col gap-2 flex-shrink-0">
                        <button onclick="handleEdit(${q.id})" class="text-[10px] bg-neo-yellow text-black px-2 py-1 text-pixel pixel-btn whitespace-nowrap">Edit</button>
                        <button onclick="deleteQuiz(${q.id})" class="text-[10px] bg-red-500 text-white px-2 py-1 text-pixel pixel-btn whitespace-nowrap">Hapus</button>
                    </div>
                </div>`
            ).join('') || '<p class="bg-white p-3 pixel-border-sm text-sm">Belum ada soal.</p>';
        }

        async function loadSubmissions(filterKelas = 'semua') {
            const response = await fetch(`/api/submissions?kelas=${encodeURIComponent(filterKelas)}`);
            const submissions = await response.json();
            
            submissionsTable.innerHTML = submissions.map(s => `
                <tr>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${s.student_name}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${s.student_absen}</td>
                    <td class="px-4 py-2 whitespace-nowrap font-semibold text-sm">${s.student_class}</td>
                    <td class="px-4 py-2 whitespace-nowrap font-bold text-blue-600 text-sm">${s.score}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <button onclick="deleteSubmission(${s.student_absen}, '${s.student_class}')" class="bg-red-500 text-white px-2 py-1 text-pixel text-[10px] pixel-btn">Hapus</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center py-4 text-sm">Tidak ada data.</td></tr>';
        }

        quizForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');

            const isEditing = !!editQuizIdInput.value;
            const payload = {
                question: quill.root.innerHTML,
                options: { a: e.target.option_a.value, b: e.target.option_b.value, c: e.target.option_c.value, d: e.target.option_d.value, e: e.target.option_e.value },
                correct_answer: e.target.correct_answer.value,
                image_base64: imageBase64Input.value || null,
                image_mimetype: imageMimeTypeInput.value || null
            };

            const url = isEditing ? `/api/quizzes/${editQuizIdInput.value}` : '/api/quizzes';
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'Gagal menyimpan soal.');
                }
                Swal.fire('Berhasil!', `Soal berhasil ${isEditing ? 'diperbarui' : 'disimpan'}.`, 'success');
                cancelEdit();
                loadQuizzes();
            } catch (error) {
                 Swal.fire('Gagal', `Terjadi kesalahan: ${error.message}`, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function deleteQuiz(id) {
            const result = await Swal.fire({
                title: 'Anda yakin?', text: "Soal ini akan dihapus permanen!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!', cancelButtonText: 'Batal'
            });
            if (result.isConfirmed) {
                await fetch(`/api/quizzes/${id}`, { method: 'DELETE' });
                loadQuizzes();
                Swal.fire('Dihapus!', 'Soal telah berhasil dihapus.', 'success');
            }
        }
        
        async function deleteSubmission(absen, kelas) {
            const result = await Swal.fire({
                title: 'Anda yakin?', text: `Hapus nilai siswa absen ${absen} dari kelas ${kelas}?`, icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!', cancelButtonText: 'Batal'
            });
            if (result.isConfirmed) {
                await fetch(`/api/submissions/${absen}/${kelas}`, { method: 'DELETE' });
                loadSubmissions(classFilter.value);
                Swal.fire('Dihapus!', 'Nilai siswa telah dihapus.', 'success');
            }
        }
        
        logoutBtn.addEventListener('click', async () => {
            const response = await fetch('/api/logout', { method: 'POST' });
            if (response.ok) {
                window.location.href = (await response.json()).redirectUrl;
            }
        });
    </script>
</body>
</html>